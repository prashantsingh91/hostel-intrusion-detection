<!DOCTYPE html>
<html>
<head>
    <title>Face Recognition System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
        }
        .header {
            background: rgba(0,0,0,0.3);
            padding: 15px 20px;
            backdrop-filter: blur(10px);
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }
        .header h1 {
            font-size: 2em;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .main-container {
            display: flex;
            height: calc(100vh - 80px);
            gap: 20px;
            padding: 20px;
        }
        .video-section {
            flex: 0.7;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            position: relative;
        }
        .stats-panel {
            flex: 0.3;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            overflow-y: auto;
        }
        .video-container {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 10px;
            overflow: hidden;
        }
        .video-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 10px;
        }
        .status-bar {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,255,0,0.9);
            color: black;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            z-index: 10;
        }
        .stats-panel h2 {
            color: #51cf66;
            margin-bottom: 20px;
            text-align: center;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        .stat-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #51cf66;
        }
        .stat-label {
            font-size: 0.8em;
            opacity: 0.8;
        }
        .video-selection {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .video-selection h3 {
            margin: 0 0 10px 0;
            color: #51cf66;
            font-size: 1.1em;
        }
        .video-selection select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .video-selection select:focus {
            outline: none;
            border-color: #51cf66;
            box-shadow: 0 0 5px rgba(81, 207, 102, 0.3);
        }
        .controls {
            margin-top: 20px;
            text-align: center;
        }
        .btn {
            background: #51cf66;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        .btn:hover {
            background: #40c057;
        }
        .btn.danger {
            background: #ff6b6b;
        }
        .btn.danger:hover {
            background: #ff5252;
        }
        .recognized-people {
            margin-top: 20px;
        }
        .person-item {
            background: rgba(255,255,255,0.1);
            margin: 5px 0;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #51cf66;
        }
        .unknown-snapshots {
            margin-top: 20px;
        }
        .unknown-snapshots h3 {
            margin-bottom: 10px;
            color: #ff6b6b;
        }
        .snapshot-item {
            display: inline-block;
            margin: 5px;
            text-align: center;
            background: rgba(255,255,255,0.1);
            padding: 8px;
            border-radius: 8px;
            border: 1px solid rgba(255,107,107,0.3);
        }
        .snapshot-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
        }
        .snapshot-item .timestamp {
            font-size: 0.7em;
            color: #ccc;
            margin-top: 4px;
        }
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                height: auto;
            }
            .video-section, .stats-panel {
                flex: none;
            }
        }
    </style>
    </head>
    <body>
        <div class="header">
            <h1>üë§ Face Recognition System</h1>
        </div>
        
        <div class="main-container">
            <div class="video-section">
                <div class="video-container">
                    <div class="status-bar" id="statusBar">READY</div>
                    <img src="/video_feed" alt="Live Video Feed">
                </div>
            </div>
            
            <div class="stats-panel">
                <h2>üìä Statistics</h2>
                
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="frameCount">0</div>
                        <div class="stat-label">Frames Processed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="fps">0</div>
                        <div class="stat-label">FPS</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="facesDetected">0</div>
                        <div class="stat-label">Faces Detected</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="peopleRecognized">0</div>
                        <div class="stat-label">People Recognized</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="activeTracks">0</div>
                        <div class="stat-label">Active Tracks</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="gpuMemory">0%</div>
                        <div class="stat-label">GPU Memory</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="processingTime">0ms</div>
                        <div class="stat-label">Processing Time</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="progress">0%</div>
                        <div class="stat-label">Progress</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="trackerType">-</div>
                        <div class="stat-label">Tracker</div>
                    </div>
                </div>
                
                <div class="recognized-people">
                    <h3>üë• Recognized People</h3>
                    <div id="peopleList">
                        <div style="text-align: center; color: #666; font-style: italic;">No people recognized yet</div>
                    </div>
                </div>
                
                <div class="unknown-snapshots">
                    <h3>üì∏ Unknown Snapshots</h3>
                    <div id="unknownSnapshotsGallery">
                        <div style="text-align: center; color: #666; font-style: italic;">No unknown snapshots yet</div>
                    </div>
                </div>
                
                
                <div class="controls">
                    <button class="btn" onclick="startProcessing()">‚ñ∂Ô∏è Start</button>
                    <button class="btn danger" onclick="stopProcessing()">‚èπÔ∏è Stop</button>
                    <button class="btn" onclick="takeSnapshot()">üì∏ Snapshot</button>
                </div>
            </div>
        </div>

        <script>
            let updateInterval;
            
            function updateStats() {
                fetch('/api/stats')
                    .then(r => r.json())
                    .then(data => {
                        // Basic stats
                        document.getElementById('frameCount').textContent = data.frame_count || 0;
                        document.getElementById('fps').textContent = (data.fps || 0).toFixed(1);
                        document.getElementById('facesDetected').textContent = data.faces_detected || 0;
                        document.getElementById('peopleRecognized').textContent = data.people_recognized || 0;
                        
                        // Phase 1 enhanced stats
                        document.getElementById('activeTracks').textContent = data.active_tracks || 0;
                        document.getElementById('gpuMemory').textContent = (data.gpu_memory_used || 0).toFixed(1) + '%';
                        document.getElementById('processingTime').textContent = ((data.processing_time || 0) * 1000).toFixed(1) + 'ms';
                        document.getElementById('progress').textContent = (data.progress || 0).toFixed(1) + '%';
                        
                        // Update status bar
                        const statusBar = document.getElementById('statusBar');
                        if (data.is_processing) {
                            statusBar.textContent = 'PROCESSING (Phase 1)';
                            statusBar.style.background = 'rgba(0,255,0,0.9)';
                        } else {
                            statusBar.textContent = 'READY (Phase 1)';
                            statusBar.style.background = 'rgba(255,165,0,0.9)';
                        }

                        // Tracker status
                        const tracker = data.tracker || {};
                        const trackerText = tracker.type === 'deepsort' ? 'DeepSORT (active)' : (tracker.deepsort_available ? 'Fallback (DeepSORT available)' : 'Fallback (DeepSORT not installed)');
                        const trackerEl = document.getElementById('trackerType');
                        if (trackerEl) trackerEl.textContent = trackerText;
                        
                        // Update people list
                        const peopleList = document.getElementById('peopleList');
                        if (data.people_list && data.people_list.length > 0) {
                            peopleList.innerHTML = data.people_list.map(person => 
                                `<div class="person-item">${person}</div>`
                            ).join('');
                        } else {
                            peopleList.innerHTML = '<div style="text-align: center; color: #666; font-style: italic;">No people recognized yet</div>';
                        }
                    })
                    .catch(e => console.error('Error fetching stats:', e));
            }
            
            function updateUnknownSnapshots() {
                fetch('/api/snapshots/unknown')
                    .then(r => r.json())
                    .then(data => {
                        const gallery = document.getElementById('unknownSnapshotsGallery');
                        if (data.snapshots && data.snapshots.length > 0) {
                            gallery.innerHTML = data.snapshots.map(s => `
                                <div class="snapshot-item">
                                    <a href="${s.url}" target="_blank">
                                        <img src="${s.url}" alt="Unknown Snapshot" width="80" height="80">
                                    </a>
                                    <div class="timestamp">${s.timestamp}</div>
                                </div>
                            `).join('');
                        } else {
                            gallery.innerHTML = '<div style="text-align: center; color: #666; font-style: italic;">No unknown snapshots yet</div>';
                        }
                    })
                    .catch(e => console.error('Error fetching unknown snapshots:', e));
            }
            
            function startProcessing() {
                fetch('/api/start', { method: 'POST' })
                    .then(r => r.json())
                    .then(data => {
                        if (data.status === 'success') {
                            console.log('Processing started');
                            updateInterval = setInterval(updateStats, 1000);
                        } else {
                            alert('Failed to start processing: ' + (data.message || 'Unknown error'));
                        }
                    })
                    .catch(e => {
                        console.error('Error starting processing:', e);
                        alert('Error starting processing: ' + e.message);
                    });
            }
            
            function stopProcessing() {
                fetch('/api/stop', {method: 'POST'})
                    .then(r => r.json())
                    .then(data => {
                        if (data.status === 'success') {
                            console.log('Processing stopped');
                            if (updateInterval) {
                                clearInterval(updateInterval);
                            }
                        }
                    })
                    .catch(e => console.error('Error stopping processing:', e));
            }
            
            function takeSnapshot() {
                fetch('/api/snapshot', {method: 'POST'})
                    .then(r => r.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Create download link
                            const link = document.createElement('a');
                            link.href = data.image_url;
                            link.download = data.filename;
                            link.click();
                            
                            // Show success message
                            const btn = event.target;
                            const originalText = btn.textContent;
                            btn.textContent = '‚úÖ Saved!';
                            setTimeout(() => {
                                btn.textContent = originalText;
                            }, 2000);
                        } else {
                            alert('Failed to take snapshot: ' + (data.message || 'Unknown error'));
                        }
                    })
                    .catch(e => {
                        console.error('Error taking snapshot:', e);
                        alert('Error taking snapshot: ' + e.message);
                    });
            }
            
            // Initial load
            updateStats();
            updateUnknownSnapshots(); // Load unknown snapshots on page load
            
            // Set up periodic updates
            setInterval(updateUnknownSnapshots, 5000); // Update unknown snapshots every 5 seconds
        </script>
    </body>
    </html>


